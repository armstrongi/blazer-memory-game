@page "/memory"

<h3>Memory Card Game</h3>

<div class="game-board">
    @for (int i = 0; i < Cards.Count; i++)
    {
        var index = i; // Capture the current value of i
        <button class="card" @onclick="() => FlipCard(index)" disabled="@DisableCard(index)">
            @if (Cards[index].IsFlipped || Cards[index].IsMatched)
            {
                <img src="@Cards[index].ImagePath" />
            }
            else
            {
                <span>?</span>
            }
        </button>
    }
</div>

@if (LowestMoves > 0)
{
    <p>Best score: @LowestMoves moves</p>
}

<p>Moves: @Moves</p>

@if (Message.StartsWith("You won"))
{
    <p>
        @Message
        <button @onclick="StartGame" style="margin-left:1em;">Restart Game</button>
    </p>
}
else
{
    <p>@Message</p>
}

@code {
    private class CardModel
    {
        public string? Value { get; set; }
        public string? ImagePath { get; set; }
        public bool IsFlipped { get; set; }
        public bool IsMatched { get; set; }
    }

    private List<CardModel> Cards = new();
    private int Moves = 0;
    private int LowestMoves = 0;
    private int flippedIndex1 = -1;
    private int flippedIndex2 = -1;
    private string Message = string.Empty;

    protected override void OnInitialized()
    {
        StartGame();
    }

    private void StartGame()
    {
        var values = new List<string> { "bear", "cat", "dog", "elephant", "fox", "frog", "penguin", "rabbit" };
        var allValues = values.Concat(values).OrderBy(_ => Guid.NewGuid()).ToList();
        Cards = allValues.Select(v => new CardModel { Value = v, ImagePath = $"/images/{v}.png" }).ToList();
        Moves = 0;
        flippedIndex1 = -1;
        flippedIndex2 = -1;
        Message = string.Empty;
        StateHasChanged();
    }

    private async Task FlipCard(int index)
    {                
        if (index < 0 || index >= Cards.Count)
            return;

        if (Cards[index].IsFlipped || Cards[index].IsMatched || flippedIndex2 != -1)
            return;

        Cards[index].IsFlipped = true;

        if (flippedIndex1 == -1)
        {
            flippedIndex1 = index;
        }
        else
        {
            flippedIndex2 = index;
            Moves++;
            StateHasChanged();
            await Task.Delay(1000);
            CheckForMatch();
            StateHasChanged();
        }
    }

    private bool DisableCard(int index)
    {        
        return Cards[index].IsMatched || Cards[index].IsFlipped;
    }
    private void CheckForMatch()
    {
        if (Cards[flippedIndex1].Value == Cards[flippedIndex2].Value)
        {
            Cards[flippedIndex1].IsMatched = true;
            Cards[flippedIndex2].IsMatched = true;
            Message = "Match!";
        }
        else
        {
            Cards[flippedIndex1].IsFlipped = false;
            Cards[flippedIndex2].IsFlipped = false;
            Message = "Try again!";
        }
        flippedIndex1 = -1;
        flippedIndex2 = -1;
        if (Cards.All(c => c.IsMatched))
        {
            Message = $"You won in {Moves} moves!";

            if (LowestMoves == 0 || Moves < LowestMoves)
            {
                LowestMoves = Moves;
            }
        }
    }
}
